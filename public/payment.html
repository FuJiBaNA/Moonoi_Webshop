<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เติมเงิน - Moonoi Developer</title>
    <meta name="description" content="เติมเงินเข้าระบบ Moonoi Developer">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    
    <style>
        .amount-input {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
        }
        .step.active .step-number {
            background: #0d6efd;
            color: white;
        }
        .step.completed::after {
            background: #198754;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .step-title {
            font-size: 0.9em;
            color: #6c757d;
        }
        .step.active .step-title {
            color: #0d6efd;
            font-weight: bold;
        }
        .slip-preview {
            max-width: 200px;
            max-height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-code me-2"></i>
                <span>Moonoi Developer</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">หน้าแรก</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">สินค้า</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/payment">เติมเงิน</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/cart">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="badge bg-primary ms-1" id="cartCount">0</span>
                        </a>
                    </li>
                    
                    <li class="nav-item" id="guestNav">
                        <a class="nav-link" href="/login">เข้าสู่ระบบ</a>
                    </li>
                    
                    <li class="nav-item" id="userNav" style="display: none;">
                        <div class="dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="usernameDisplay"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/dashboard"><i class="fas fa-tachometer-alt me-2"></i>แดชบอร์ด</a></li>
                                <li><a class="dropdown-item" href="/payment"><i class="fas fa-credit-card me-2"></i>เติมเงิน</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="margin-top: 100px; min-height: 70vh;">
        <div class="row">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h2><i class="fas fa-credit-card me-2"></i>เติมเงิน</h2>
                    <a href="/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>กลับแดชบอร์ด
                    </a>
                </div>
            </div>
        </div>

        <!-- Guest Message -->
        <div id="guestMessage" class="row" style="display: none;">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <h5><i class="fas fa-user-lock me-2"></i>กรุณาเข้าสู่ระบบ</h5>
                    <p class="mb-3">เพื่อใช้งานระบบเติมเงิน</p>
                    <a href="/login?returnUrl=/payment" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt me-1"></i>เข้าสู่ระบบ
                    </a>
                </div>
            </div>
        </div>

        <!-- Payment Content -->
        <div id="paymentContent" class="row">
            <!-- Current Balance -->
            <div class="col-12 mb-4">
                <div class="alert alert-info">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h5 class="mb-0">
                                <i class="fas fa-wallet me-2"></i>เครดิตปัจจุบัน: 
                                <span class="badge bg-success fs-5" id="currentBalance">฿0.00</span>
                            </h5>
                        </div>
                        <div class="col-lg-4 text-end">
                            <a href="#paymentHistory" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-history me-1"></i>ประวัติการเติมเงิน
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-money-bill me-2"></i>เลือกวิธีการชำระเงิน</h5>
                    </div>
                    <div class="card-body">
                        <!-- Payment Method Tabs -->
                        <ul class="nav nav-pills mb-4" id="paymentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="truewallet-tab" data-bs-toggle="pill" 
                                        data-bs-target="#truewallet" type="button" role="tab">
                                    <i class="fas fa-mobile-alt me-2"></i>TrueWallet
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="bank-tab" data-bs-toggle="pill" 
                                        data-bs-target="#bank" type="button" role="tab">
                                    <i class="fas fa-university me-2"></i>โอนธนาคาร
                                </button>
                            </li>
                        </ul>

                        <!-- Payment Method Content -->
                        <div class="tab-content" id="paymentTabsContent">
                            <!-- TrueWallet -->
                            <div class="tab-pane fade show active" id="truewallet" role="tabpanel">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>วิธีการเติมเงินผ่าน TrueWallet</h6>
                                    <ol class="mb-0">
                                        <li>ส่งซองของขวัญ TrueWallet ไปยังเบอร์: <strong>0123456789</strong></li>
                                        <li>คัดลอกลิงก์ของขวัญที่ได้รับมาใส่ในช่องด้านล่าง</li>
                                        <li>กดยืนยันและรอการตรวจสอบ</li>
                                    </ol>
                                </div>

                                <form id="truewalletForm">
                                    <div class="mb-3">
                                        <label for="giftLink" class="form-label">
                                            <i class="fas fa-gift me-2"></i>ลิงก์ของขวัญ TrueWallet
                                        </label>
                                        <input type="url" class="form-control" id="giftLink" 
                                               placeholder="https://gift.truemoney.com/campaign/?v=..." required>
                                        <div class="form-text">วางลิงก์ของขวัญ TrueWallet ที่ได้รับจากการส่งซองของขวัญ</div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg" id="truewalletBtn">
                                            <i class="fas fa-mobile-alt me-2"></i>ยืนยันการเติมเงิน
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Bank Transfer -->
                            <div class="tab-pane fade" id="bank" role="tabpanel">
                                <!-- Step Indicator -->
                                <div class="step-indicator">
                                    <div class="step active" id="step1">
                                        <div class="step-number">1</div>
                                        <div class="step-title">กรอกจำนวนเงิน</div>
                                    </div>
                                    <div class="step" id="step2">
                                        <div class="step-number">2</div>
                                        <div class="step-title">โอนเงิน</div>
                                    </div>
                                    <div class="step" id="step3">
                                        <div class="step-number">3</div>
                                        <div class="step-title">อัปโหลดสลิป</div>
                                    </div>
                                </div>

                                <!-- Step 1: Enter Amount -->
                                <div id="amountStep">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle me-2"></i>กรอกจำนวนเงินที่ต้องการเติม</h6>
                                        <p class="mb-0">กรุณากรอกจำนวนเงินที่ต้องการเติม จากนั้นระบบจะแสดงข้อมูลบัญชีสำหรับโอนเงิน</p>
                                    </div>

                                    <form id="amountForm">
                                        <div class="mb-3">
                                            <label for="transferAmount" class="form-label">
                                                <i class="fas fa-money-bill me-2"></i>จำนวนเงิน (บาท)
                                            </label>
                                            <input type="number" class="form-control amount-input" id="transferAmount" 
                                                   placeholder="0" min="10" max="50000" required>
                                            <div class="form-text">จำนวนเงินขั้นต่ำ 10 บาท ขั้นสูงสุด 50,000 บาท</div>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-arrow-right me-2"></i>ดำเนินการต่อ
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Step 2: Bank Details & Transfer -->
                                <div id="bankDetailsStep" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-university me-2"></i>ข้อมูลบัญชีสำหรับโอนเงิน</h6>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <p class="mb-1"><strong>ธนาคาร:</strong> กสิกรไทย</p>
                                                <p class="mb-1"><strong>เลขบัญชี:</strong> 123-4-56789-0</p>
                                                <p class="mb-1"><strong>ชื่อบัญชี:</strong> Moonoi Developer</p>
                                                <p class="mb-0"><strong>จำนวนที่ต้องโอน:</strong> 
                                                    <span class="badge bg-warning text-dark fs-6" id="displayAmount">฿0</span>
                                                </p>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjZjhmOWZhIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5RUiBDb2RlPC90ZXh0Pgo8L3N2Zz4=" 
                                                     alt="QR Code" class="img-fluid" style="max-width: 80px;">
                                                <p class="small text-muted mt-1">QR Code สำหรับโอนเงิน</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>ข้อควรระวัง</h6>
                                        <ul class="mb-0">
                                            <li>กรุณาโอนเงินตามจำนวนที่ระบุอย่างแม่นยำ</li>
                                            <li>ใช้สลิปที่มี QR Code เท่านั้น</li>
                                            <li>สลิปต้องไม่เก่าเกิน 24 ชั่วโมง</li>
                                        </ul>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                        <button type="button" class="btn btn-outline-secondary" onclick="goBackToAmount()">
                                            <i class="fas fa-arrow-left me-2"></i>กลับแก้ไขจำนวน
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="proceedToSlipUpload()">
                                            <i class="fas fa-arrow-right me-2"></i>โอนเงินเรียบร้อย อัปโหลดสลิป
                                        </button>
                                    </div>
                                </div>

                                <!-- Step 3: Upload Slip -->
                                <div id="slipUploadStep" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-upload me-2"></i>อัปโหลดสลิปการโอนเงิน</h6>
                                        <p class="mb-0">อัปโหลดรูปสลิปการโอนเงิน ระบบจะอ่าน QR Code อัตโนมัติและตรวจสอบการชำระเงิน</p>
                                    </div>

                                    <form id="bankTransferForm">
                                        <div class="mb-3">
                                            <label for="slipImage" class="form-label">
                                                <i class="fas fa-image me-2"></i>รูปสลิปการโอนเงิน
                                            </label>
                                            <input type="file" class="form-control" id="slipImage" 
                                                   accept="image/jpeg,image/png,image/jpg" required>
                                            <div class="form-text">อัปโหลดรูปสลิปการโอนเงิน (JPG, PNG เท่านั้น, ขนาดไม่เกิน 10MB)</div>
                                        </div>

                                        <!-- Slip Preview -->
                                        <div id="slipPreview" class="mb-3" style="display: none;">
                                            <label class="form-label">ตัวอย่างสลิป:</label>
                                            <div class="text-center">
                                                <img id="previewImage" class="slip-preview" src="#" alt="Slip Preview">
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                            <button type="button" class="btn btn-outline-secondary" onclick="goBackToBankDetails()">
                                                <i class="fas fa-arrow-left me-2"></i>กลับ
                                            </button>
                                            <button type="submit" class="btn btn-success btn-lg" id="bankTransferBtn">
                                                <i class="fas fa-check me-2"></i>ยืนยันการเติมเงิน
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Amount Selection -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>จำนวนเงินแนะนำ</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(100)">฿100</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(200)">฿200</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(500)">฿500</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(1000)">฿1,000</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(2000)">฿2,000</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(5000)">฿5,000</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Security -->
                <div class="card mt-3">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-shield-alt text-success me-2"></i>ความปลอดภัย</h6>
                        <p class="text-muted small mb-0">
                            ระบบการเงินของเราได้รับการคุ้มครองด้วยเทคโนโลยีการเข้ารหัสระดับสูง
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History -->
        <div class="row mt-5" id="paymentHistory">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>ประวัติการเติมเงิน</h5>
                    </div>
                    <div class="card-body">
                        <div id="paymentHistoryContainer">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">กำลังโหลด...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // ใช้ window.currentUser แทน let currentUser เพื่อหลีกเลี่ยงการประกาศซ้ำ
        window.currentUser = window.currentUser || null;
        let selectedAmount = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupForms();
            loadPaymentHistory();
            setupFilePreview();
        });

        // Check authentication
        async function checkAuth() {
            authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                document.getElementById('guestMessage').style.display = 'block';
                document.getElementById('paymentContent').style.display = 'none';
                showGuestNavigation();
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.currentUser = data.user;
                    document.getElementById('currentBalance').textContent = formatPrice(window.currentUser.credits);
                    showUserNavigation();
                    updateUserDisplay();
                } else {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    document.getElementById('guestMessage').style.display = 'block';
                    document.getElementById('paymentContent').style.display = 'none';
                    showGuestNavigation();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                document.getElementById('guestMessage').style.display = 'block';
                document.getElementById('paymentContent').style.display = 'none';
                showGuestNavigation();
            }
        }

        // Setup forms
        function setupForms() {
            // TrueWallet form
            document.getElementById('truewalletForm').addEventListener('submit', handleTrueWalletPayment);

            // Amount form
            document.getElementById('amountForm').addEventListener('submit', handleAmountSubmit);

            // Bank transfer form
            document.getElementById('bankTransferForm').addEventListener('submit', handleBankTransfer);
        }

        // Setup file preview
        function setupFilePreview() {
            const slipImage = document.getElementById('slipImage');
            slipImage.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewImage = document.getElementById('previewImage');
                        previewImage.src = e.target.result;
                        document.getElementById('slipPreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Handle amount submit
        function handleAmountSubmit(e) {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('transferAmount').value);

            if (!amount || amount < 10 || amount > 50000) {
                showAlert('กรุณากรอกจำนวนเงิน 10-50,000 บาท', 'warning');
                return;
            }

            selectedAmount = amount;
            document.getElementById('displayAmount').textContent = formatPrice(amount);

            // Update step indicator
            updateStepIndicator(2);

            // Show bank details step
            document.getElementById('amountStep').style.display = 'none';
            document.getElementById('bankDetailsStep').style.display = 'block';
        }

        // Proceed to slip upload
        function proceedToSlipUpload() {
            updateStepIndicator(3);
            document.getElementById('bankDetailsStep').style.display = 'none';
            document.getElementById('slipUploadStep').style.display = 'block';
        }

        // Go back to amount step
        function goBackToAmount() {
            updateStepIndicator(1);
            document.getElementById('bankDetailsStep').style.display = 'none';
            document.getElementById('amountStep').style.display = 'block';
        }

        // Go back to bank details
        function goBackToBankDetails() {
            updateStepIndicator(2);
            document.getElementById('slipUploadStep').style.display = 'none';
            document.getElementById('bankDetailsStep').style.display = 'block';
        }

        // Update step indicator
        function updateStepIndicator(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < activeStep) {
                    step.classList.add('completed');
                } else if (i === activeStep) {
                    step.classList.add('active');
                }
            }
        }

        // Handle TrueWallet payment
        async function handleTrueWalletPayment(e) {
            e.preventDefault();

            const giftLink = document.getElementById('giftLink').value;
            const submitBtn = document.getElementById('truewalletBtn');

            if (!giftLink || !giftLink.includes('gift.truemoney.com')) {
                showAlert('กรุณาใส่ลิงก์ของขวัญ TrueWallet ที่ถูกต้อง', 'warning');
                return;
            }

            showLoading(submitBtn);

            try {
                const response = await fetch('/api/payments/truewallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ gift_link: giftLink })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`เติมเงินสำเร็จ! จำนวน ${formatPrice(data.data.amount)}`, 'success');
                    
                    // Update balance
                    window.currentUser.credits = data.data.new_balance;
                    document.getElementById('currentBalance').textContent = formatPrice(window.currentUser.credits);
                    
                    // Reset form
                    document.getElementById('truewalletForm').reset();
                    
                    // Reload payment history
                    loadPaymentHistory();
                } else {
                    showAlert(data.error || 'ไม่สามารถเติมเงินได้', 'danger');
                }

            } catch (error) {
                console.error('TrueWallet payment error:', error);
                showAlert('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'danger');
            } finally {
                hideLoading(submitBtn);
            }
        }

        // Handle bank transfer
        async function handleBankTransfer(e) {
            e.preventDefault();

            const slipImage = document.getElementById('slipImage').files[0];
            const submitBtn = document.getElementById('bankTransferBtn');

            if (!slipImage) {
                showAlert('กรุณาเลือกรูปสลิปการโอนเงิน', 'warning');
                return;
            }

            if (!selectedAmount) {
                showAlert('ไม่พบข้อมูลจำนวนเงิน กรุณาเริ่มใหม่', 'danger');
                goBackToAmount();
                return;
            }

            // Check file size (max 10MB)
            if (slipImage.size > 10 * 1024 * 1024) {
                showAlert('ขนาดไฟล์ต้องไม่เกิน 10MB', 'warning');
                return;
            }

            showLoading(submitBtn);

            try {
                const formData = new FormData();
                formData.append('slip_image', slipImage);
                formData.append('expected_amount', selectedAmount);

                const response = await fetch('/api/payments/slip-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`เติมเงินสำเร็จ! จำนวน ${formatPrice(data.data.amount)}`, 'success');
                    
                    // Update balance
                    window.currentUser.credits = data.data.new_balance;
                    document.getElementById('currentBalance').textContent = formatPrice(window.currentUser.credits);
                    
                    // Reset everything
                    resetBankTransferForm();
                    
                    // Reload payment history
                    loadPaymentHistory();
                } else {
                    showAlert(data.error || 'ไม่สามารถเติมเงินได้', 'danger');
                }

            } catch (error) {
                console.error('Bank transfer error:', error);
                showAlert('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'danger');
            } finally {
                hideLoading(submitBtn);
            }
        }

        // Reset bank transfer form
        function resetBankTransferForm() {
            selectedAmount = 0;
            document.getElementById('transferAmount').value = '';
            document.getElementById('bankTransferForm').reset();
            document.getElementById('slipPreview').style.display = 'none';
            
            // Reset to step 1
            updateStepIndicator(1);
            document.getElementById('slipUploadStep').style.display = 'none';
            document.getElementById('bankDetailsStep').style.display = 'none';
            document.getElementById('amountStep').style.display = 'block';
        }

        // Set amount suggestion
        function setAmount(amount) {
            const amountInput = document.getElementById('transferAmount');
            if (amountInput && document.getElementById('amountStep').style.display !== 'none') {
                amountInput.value = amount;
            }
        }

        // Load payment history
        async function loadPaymentHistory() {
            if (!authToken) return;

            try {
                const response = await fetch('/api/payments/history?limit=10', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                const container = document.getElementById('paymentHistoryContainer');

                if (data.success && data.data.payments.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th>วิธีการ</th>
                                        <th class="text-end">จำนวนเงิน</th>
                                        <th class="text-center">สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.payments.map(payment => `
                                        <tr>
                                            <td>${formatDate(payment.created_at)}</td>
                                            <td>
                                                <i class="fas fa-${payment.method_type === 'truewallet' ? 'mobile-alt' : 'university'} me-2"></i>
                                                ${payment.method_type === 'truewallet' ? 'TrueWallet' : 'โอนธนาคาร'}
                                            </td>
                                            <td class="text-end">
                                                <strong class="text-success">${formatPrice(payment.amount)}</strong>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-${getPaymentStatusColor(payment.status)}">
                                                    ${getPaymentStatusText(payment.status)}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center text-muted py-3">ยังไม่มีประวัติการเติมเงิน</div>';
                }

            } catch (error) {
                console.error('Load payment history error:', error);
                document.getElementById('paymentHistoryContainer').innerHTML = 
                    '<div class="text-center text-muted py-3">ไม่สามารถโหลดประวัติได้</div>';
            }
        }

        // Get payment status color
        function getPaymentStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'processing': 'info',
                'completed': 'success',
                'failed': 'danger',
                'cancelled': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        // Get payment status text
        function getPaymentStatusText(status) {
            const texts = {
                'pending': 'รอดำเนินการ',
                'processing': 'กำลังตรวจสอบ',
                'completed': 'สำเร็จ',
                'failed': 'ล้มเหลว',
                'cancelled': 'ยกเลิก'
            };
            return texts[status] || status;
        }
    </script>

<script>
async function api(path, opts={}){
  const t = localStorage.getItem('authToken');
  const headers = Object.assign({'Content-Type':'application/json'}, t ? {'Authorization':'Bearer '+t} : {});
  const res = await fetch(path, Object.assign({ headers }, opts));
  if(!res.ok) throw new Error('Request failed');
  return res.json();
}
async function loadTransactions(){
  try{
    const data = await api('/api/payments/transactions');
    const list = data.transactions || [];
    const wrap = document.getElementById('paymentsTransactions') || (function(){
      const div = document.createElement('div'); div.id='paymentsTransactions';
      div.innerHTML = '<h5 class="mt-4">ประวัติการเติมเงิน</h5><div id="txWrap"></div>';
      document.querySelector('main')?.appendChild(div); return div;
    })();
    const txWrap = document.getElementById('txWrap');
    txWrap.innerHTML = '';
    list.forEach(tx=>{
      const row = document.createElement('div');
      row.className = 'border rounded p-2 mb-2';
      row.innerHTML = '<div><strong>#'+tx.id+'</strong> ['+tx.method+'] '+(tx.status.toUpperCase())+' '
        + (tx.amount_confirmed? ('- ยอดยืนยัน '+tx.amount_confirmed): (tx.amount_expected? ('- ยอดที่แจ้ง '+tx.amount_expected):'')) 
        + ' <span class="text-muted">('+(new Date(tx.created_at)).toLocaleString()+')</span></div>';
      txWrap.appendChild(row);
    });
  }catch(e){ console.warn(e); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  const banner = document.createElement('div');
  banner.className = 'alert alert-info';
  banner.innerHTML = '<i class="fa fa-clock me-2"></i>หลังอัปโหลดสลิป ระบบจะอยู่ในสถานะ <strong>รอตรวจสอบ</strong> โดยแอดมิน/API ก่อนจึงจะได้เครดิต';
  document.querySelector('main')?.prepend(banner);
  loadTransactions();
});
</script>
</body>
</html>