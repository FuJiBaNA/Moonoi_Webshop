<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เติมเงิน - Moonoi Developer</title>
    <meta name="description" content="เติมเงินเข้าระบบ Moonoi Developer">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-code me-2"></i>
                <span>Moonoi Developer</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">หน้าแรก</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">สินค้า</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/payment">เติมเงิน</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/cart">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="badge bg-primary ms-1" id="cartCount">0</span>
                        </a>
                    </li>
                    
                    <li class="nav-item" id="guestNav">
                        <a class="nav-link" href="/login">เข้าสู่ระบบ</a>
                    </li>
                    
                    <li class="nav-item" id="userNav" style="display: none;">
                        <div class="dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="usernameDisplay"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/dashboard"><i class="fas fa-tachometer-alt me-2"></i>แดชบอร์ด</a></li>
                                <li><a class="dropdown-item" href="/payment"><i class="fas fa-credit-card me-2"></i>เติมเงิน</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="margin-top: 100px; min-height: 70vh;">
        <div class="row">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h2><i class="fas fa-credit-card me-2"></i>เติมเงิน</h2>
                    <a href="/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>กลับแดชบอร์ด
                    </a>
                </div>
            </div>
        </div>

        <!-- Guest Message -->
        <div id="guestMessage" class="row" style="display: none;">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <h5><i class="fas fa-user-lock me-2"></i>กรุณาเข้าสู่ระบบ</h5>
                    <p class="mb-3">เพื่อใช้งานระบบเติมเงิน</p>
                    <a href="/login?returnUrl=/payment" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt me-1"></i>เข้าสู่ระบบ
                    </a>
                </div>
            </div>
        </div>

        <!-- Payment Content -->
        <div id="paymentContent" class="row">
            <!-- Current Balance -->
            <div class="col-12 mb-4">
                <div class="alert alert-info">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h5 class="mb-0">
                                <i class="fas fa-wallet me-2"></i>เครดิตปัจจุบัน: 
                                <span class="badge bg-success fs-5" id="currentBalance">฿0.00</span>
                            </h5>
                        </div>
                        <div class="col-lg-4 text-end">
                            <a href="#paymentHistory" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-history me-1"></i>ประวัติการเติมเงิน
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-money-bill me-2"></i>เลือกวิธีการชำระเงิน</h5>
                    </div>
                    <div class="card-body">
                        <!-- Payment Method Tabs -->
                        <ul class="nav nav-pills mb-4" id="paymentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="truewallet-tab" data-bs-toggle="pill" 
                                        data-bs-target="#truewallet" type="button" role="tab">
                                    <i class="fas fa-mobile-alt me-2"></i>TrueWallet
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="bank-tab" data-bs-toggle="pill" 
                                        data-bs-target="#bank" type="button" role="tab">
                                    <i class="fas fa-university me-2"></i>โอนธนาคาร
                                </button>
                            </li>
                        </ul>

                        <!-- Payment Method Content -->
                        <div class="tab-content" id="paymentTabsContent">
                            <!-- TrueWallet -->
                            <div class="tab-pane fade show active" id="truewallet" role="tabpanel">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>วิธีการเติมเงินผ่าน TrueWallet</h6>
                                    <ol class="mb-0">
                                        <li>ส่งซองของขวัญ TrueWallet ไปยังเบอร์: <strong>0123456789</strong></li>
                                        <li>คัดลอกลิงก์ของขวัญที่ได้รับมาใส่ในช่องด้านล่าง</li>
                                        <li>กดยืนยันและรอการตรวจสอบ</li>
                                    </ol>
                                </div>

                                <form id="truewalletForm">
                                    <div class="mb-3">
                                        <label for="giftLink" class="form-label">
                                            <i class="fas fa-gift me-2"></i>ลิงก์ของขวัญ TrueWallet
                                        </label>
                                        <input type="url" class="form-control" id="giftLink" 
                                               placeholder="https://gift.truemoney.com/campaign/?v=..." required>
                                        <div class="form-text">วางลิงก์ของขวัญ TrueWallet ที่ได้รับจากการส่งซองของขวัญ</div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg" id="truewalletBtn">
                                            <i class="fas fa-mobile-alt me-2"></i>ยืนยันการเติมเงิน
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Bank Transfer -->
                            <div class="tab-pane fade" id="bank" role="tabpanel">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>ข้อมูลบัญชีสำหรับโอนเงิน</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>ธนาคาร:</strong> กสิกรไทย</p>
                                            <p class="mb-1"><strong>เลขบัญชี:</strong> 123-4-56789-0</p>
                                            <p class="mb-0"><strong>ชื่อบัญชี:</strong> Moonoi Developer</p>
                                        </div>
                                    </div>
                                </div>

                                <form id="bankTransferForm">
                                    <div class="mb-3">
                                        <label for="slipImage" class="form-label">
                                            <i class="fas fa-image me-2"></i>รูปหลักฐานการโอนเงิน
                                        </label>
                                        <input type="file" class="form-control" id="slipImage" 
                                               accept="image/jpeg,image/png,image/jpg" required>
                                        <div class="form-text">อัปโหลดรูปสลิปการโอนเงิน (JPG, PNG เท่านั้น)</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="qrcodeText" class="form-label">
                                            <i class="fas fa-qrcode me-2"></i>ข้อความใน QR Code
                                        </label>
                                        <textarea class="form-control" id="qrcodeText" rows="3" 
                                                  placeholder="คัดลอกข้อความจาก QR Code ในสลิปมาใส่ที่นี่" required></textarea>
                                        <div class="form-text">สแกน QR Code ในสลิป แล้วคัดลอกข้อความทั้งหมดมาใส่</div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg" id="bankTransferBtn">
                                            <i class="fas fa-university me-2"></i>ยืนยันการโอนเงิน
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Amount Selection -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>จำนวนเงินแนะนำ</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(100)">฿100</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(200)">฿200</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(500)">฿500</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(1000)">฿1,000</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(2000)">฿2,000</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setAmount(5000)">฿5,000</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Security -->
                <div class="card mt-3">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-shield-alt text-success me-2"></i>ความปลอดภัย</h6>
                        <p class="text-muted small mb-0">
                            ระบบการเงินของเราได้รับการคุ้มครองด้วยเทคโนโลยีการเข้ารหัสระดับสูง
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History -->
        <div class="row mt-5" id="paymentHistory">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>ประวัติการเติมเงิน</h5>
                    </div>
                    <div class="card-body">
                        <div id="paymentHistoryContainer">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">กำลังโหลด...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupForms();
            loadPaymentHistory();
        });

        // Check authentication
        async function checkAuth() {
            authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                document.getElementById('guestMessage').style.display = 'block';
                document.getElementById('paymentContent').style.display = 'none';
                showGuestNavigation();
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('currentBalance').textContent = formatPrice(currentUser.credits);
                    showUserNavigation();
                    updateUserDisplay();
                } else {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    document.getElementById('guestMessage').style.display = 'block';
                    document.getElementById('paymentContent').style.display = 'none';
                    showGuestNavigation();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                document.getElementById('guestMessage').style.display = 'block';
                document.getElementById('paymentContent').style.display = 'none';
                showGuestNavigation();
            }
        }

        // Setup forms
        function setupForms() {
            // TrueWallet form
            document.getElementById('truewalletForm').addEventListener('submit', handleTrueWalletPayment);

            // Bank transfer form
            document.getElementById('bankTransferForm').addEventListener('submit', handleBankTransfer);
        }

        // Handle TrueWallet payment
        async function handleTrueWalletPayment(e) {
            e.preventDefault();

            const giftLink = document.getElementById('giftLink').value;
            const submitBtn = document.getElementById('truewalletBtn');

            if (!giftLink || !giftLink.includes('gift.truemoney.com')) {
                showAlert('กรุณาใส่ลิงก์ของขวัญ TrueWallet ที่ถูกต้อง', 'warning');
                return;
            }

            showLoading(submitBtn);

            try {
                const response = await fetch('/api/payments/truewallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ gift_link: giftLink })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`เติมเงินสำเร็จ! จำนวน ${formatPrice(data.data.amount)}`, 'success');
                    
                    // Update balance
                    currentUser.credits = data.data.new_balance;
                    document.getElementById('currentBalance').textContent = formatPrice(currentUser.credits);
                    
                    // Reset form
                    document.getElementById('truewalletForm').reset();
                    
                    // Reload payment history
                    loadPaymentHistory();
                } else {
                    showAlert(data.error || 'ไม่สามารถเติมเงินได้', 'danger');
                }

            } catch (error) {
                console.error('TrueWallet payment error:', error);
                showAlert('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'danger');
            } finally {
                hideLoading(submitBtn);
            }
        }

        // Handle bank transfer
        async function handleBankTransfer(e) {
            e.preventDefault();

            const slipImage = document.getElementById('slipImage').files[0];
            const qrcodeText = document.getElementById('qrcodeText').value;
            const submitBtn = document.getElementById('bankTransferBtn');

            if (!slipImage) {
                showAlert('กรุณาเลือกรูปสลิปการโอนเงิน', 'warning');
                return;
            }

            if (!qrcodeText.trim()) {
                showAlert('กรุณาใส่ข้อความใน QR Code', 'warning');
                return;
            }

            // Check file size (max 10MB)
            if (slipImage.size > 10 * 1024 * 1024) {
                showAlert('ขนาดไฟล์ต้องไม่เกิน 10MB', 'warning');
                return;
            }

            showLoading(submitBtn);

            try {
                const formData = new FormData();
                formData.append('slip_image', slipImage);
                formData.append('qrcode_text', qrcodeText);

                const response = await fetch('/api/payments/slip-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`เติมเงินสำเร็จ! จำนวน ${formatPrice(data.data.amount)}`, 'success');
                    
                    // Update balance
                    currentUser.credits = data.data.new_balance;
                    document.getElementById('currentBalance').textContent = formatPrice(currentUser.credits);
                    
                    // Reset form
                    document.getElementById('bankTransferForm').reset();
                    
                    // Reload payment history
                    loadPaymentHistory();
                } else {
                    showAlert(data.error || 'ไม่สามารถเติมเงินได้', 'danger');
                }

            } catch (error) {
                console.error('Bank transfer error:', error);
                showAlert('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'danger');
            } finally {
                hideLoading(submitBtn);
            }
        }

        // Set amount suggestion (for future use with amount input)
        function setAmount(amount) {
            // This could be used if we add an amount input field
            console.log('Selected amount:', amount);
        }

        // Load payment history
        async function loadPaymentHistory() {
            if (!authToken) return;

            try {
                const response = await fetch('/api/payments/history?limit=10', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                const container = document.getElementById('paymentHistoryContainer');

                if (data.success && data.data.payments.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th>วิธีการ</th>
                                        <th class="text-end">จำนวนเงิน</th>
                                        <th class="text-center">สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.payments.map(payment => `
                                        <tr>
                                            <td>${formatDate(payment.created_at)}</td>
                                            <td>
                                                <i class="fas fa-${payment.method_type === 'truewallet' ? 'mobile-alt' : 'university'} me-2"></i>
                                                ${payment.method_type === 'truewallet' ? 'TrueWallet' : 'โอนธนาคาร'}
                                            </td>
                                            <td class="text-end">
                                                <strong class="text-success">${formatPrice(payment.amount)}</strong>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-${getPaymentStatusColor(payment.status)}">
                                                    ${getPaymentStatusText(payment.status)}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center text-muted py-3">ยังไม่มีประวัติการเติมเงิน</div>';
                }

            } catch (error) {
                console.error('Load payment history error:', error);
                document.getElementById('paymentHistoryContainer').innerHTML = 
                    '<div class="text-center text-muted py-3">ไม่สามารถโหลดประวัติได้</div>';
            }
        }

        // Get payment status color
        function getPaymentStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'processing': 'info',
                'completed': 'success',
                'failed': 'danger',
                'cancelled': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        // Get payment status text
        function getPaymentStatusText(status) {
            const texts = {
                'pending': 'รอดำเนินการ',
                'processing': 'กำลังตรวจสอบ',
                'completed': 'สำเร็จ',
                'failed': 'ล้มเหลว',
                'cancelled': 'ยกเลิก'
            };
            return texts[status] || status;
        }
    </script>
</body>
</html>