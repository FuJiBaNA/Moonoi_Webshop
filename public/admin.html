<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Moonoi Developer</title>
    <meta name="description" content="ระบบจัดการแอดมิน Moonoi Developer">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cog me-2"></i>
                <span>Admin Panel</span>
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span id="adminUsername"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/dashboard"><i class="fas fa-tachometer-alt me-2"></i>แดชบอร์ดผู้ใช้</a></li>
                        <li><a class="dropdown-item" href="/"><i class="fas fa-home me-2"></i>หน้าแรก</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="margin-top: 76px;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 bg-light vh-100 position-sticky top-0 py-3" style="top: 76px;">
                <div class="list-group list-group-flush">
                    <a href="#dashboard" class="list-group-item list-group-item-action active" data-tab="dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i>แดشบอร์ด
                    </a>
                    <a href="#products" class="list-group-item list-group-item-action" data-tab="products">
                        <i class="fas fa-box me-2"></i>จัดการสินค้า
                    </a>
                    <a href="#orders" class="list-group-item list-group-item-action" data-tab="orders">
                        <i class="fas fa-shopping-bag me-2"></i>คำสั่งซื้อ
                    </a>
                    <a href="#users" class="list-group-item list-group-item-action" data-tab="users">
                        <i class="fas fa-users me-2"></i>จัดการผู้ใช้
                    </a>
                    <a href="#payments" class="list-group-item list-group-item-action" data-tab="payments">
                        <i class="fas fa-credit-card me-2"></i>การเงิน
                    </a>
                    <a href="#licenses" class="list-group-item list-group-item-action" data-tab="licenses">
                        <i class="fas fa-key me-2"></i>License
                    </a>
                    <a href="#analytics" class="list-group-item list-group-item-action" data-tab="analytics">
                        <i class="fas fa-chart-bar me-2"></i>รายงาน
                    </a>
                    <a href="#settings" class="list-group-item list-group-item-action" data-tab="settings">
                        <i class="fas fa-cog me-2"></i>ตั้งค่าระบบ
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 p-4">
                
                <!-- Dashboard Tab -->
                <div id="dashboard-content" class="tab-content active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>แดชบอร์ดแอดมิน</h2>
                        <div class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            <span id="currentTime"></span>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalUsers">0</h4>
                                            <p class="mb-0">ผู้ใช้ทั้งหมด</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-users fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalProducts">0</h4>
                                            <p class="mb-0">สินค้าทั้งหมด</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-box fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalOrders">0</h4>
                                            <p class="mb-0">คำสั่งซื้อ</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-shopping-bag fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalRevenue">฿0</h4>
                                            <p class="mb-0">รายได้รวม</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-chart-line fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">กิจกรรมล่าสุด</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActivities">
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">สินค้าขายดี</h5>
                                </div>
                                <div class="card-body">
                                    <div id="topProducts">
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Tab -->
                <div id="products-content" class="tab-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>จัดการสินค้า</h2>
                        <button class="btn btn-primary" onclick="showCreateProductModal()">
                            <i class="fas fa-plus me-1"></i>เพิ่มสินค้า
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div id="productsTable">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="users-content" class="tab-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>จัดการผู้ใช้</h2>
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" id="userSearch" placeholder="ค้นหาผู้ใช้...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div id="usersTable">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="orders-content" class="tab-content">
                    <h2 class="mb-4">คำสั่งซื้อ</h2>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="ordersTable">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div id="payments-content" class="tab-content">
                    <h2 class="mb-4">จัดการการเงิน</h2>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">คำขอเติมเงินที่รอดำเนินการ</h5>
                                </div>
                                <div class="card-body">
                                    <div id="pendingPayments">
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">ปรับเครดิต</h5>
                                </div>
                                <div class="card-body">
                                    <form id="adjustCreditsForm">
                                        <div class="mb-3">
                                            <label class="form-label">ผู้ใช้</label>
                                            <select class="form-select" id="adjustUserId" required>
                                                <option value="">เลือกผู้ใช้...</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">จำนวน (+ หรือ -)</label>
                                            <input type="number" class="form-control" id="adjustAmount" step="0.01" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">หมายเหตุ</label>
                                            <textarea class="form-control" id="adjustReason" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-warning w-100">
                                            <i class="fas fa-edit me-1"></i>ปรับเครดิต
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-content" class="tab-content">
                    <h2 class="mb-4">ตั้งค่าระบบ</h2>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">การตั้งค่าทั่วไป</h5>
                                </div>
                                <div class="card-body">
                                    <form id="settingsForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">ชื่อเว็บไซต์</label>
                                                <input type="text" class="form-control" id="siteName">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">คำอธิบายเว็บไซต์</label>
                                                <input type="text" class="form-control" id="siteDescription">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">จำนวนเงินเติมขั้นต่ำ (บาท)</label>
                                                <input type="number" class="form-control" id="minTopupAmount" min="1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">จำนวนเงินเติมสูงสุด (บาท)</label>
                                                <input type="number" class="form-control" id="maxTopupAmount" min="1">
                                            </div>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="allowRegistration">
                                            <label class="form-check-label" for="allowRegistration">
                                                อนุญาตให้สมัครสมาชิกใหม่
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="maintenanceMode">
                                            <label class="form-check-label" for="maintenanceMode">
                                                โหมดปิดปรับปรุง
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-1"></i>บันทึกการตั้งค่า
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Modal -->
                <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">เพิ่มสินค้าใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="productName" class="form-label">ชื่อสินค้า</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">หมวดหมู่</label>
                                <select class="form-select" id="productCategory" required></select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">คำอธิบาย</label>
                        <textarea class="form-control" id="productDescription" rows="5"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                             <div class="mb-3">
                                <label for="productPrice" class="form-label">ราคา (บาท)</label>
                                <input type="number" class="form-control" id="productPrice" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                             <div class="mb-3">
                                <label for="productDiscountPrice" class="form-label">ราคาลด (ถ้ามี)</label>
                                <input type="number" class="form-control" id="productDiscountPrice" step="0.01">
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productType" class="form-label">ประเภทสินค้า</label>
                                <select class="form-select" id="productType">
                                     <option value="script">Script</option>
                                     <option value="file">File/Asset</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="productIsActive">
                        <label class="form-check-label" for="productIsActive">
                           เปิดใช้งานสินค้านี้
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" onclick="submitProductForm()">บันทึก</button>
            </div>
        </div>
    </div>
</div>

                <div id="licenses-content" class="tab-content">
                    <h2 class="mb-4">จัดการ License</h2>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ส่วนนี้อยู่ระหว่างการพัฒนา
                    </div>
                </div>

                <div id="analytics-content" class="tab-content">
                    <h2 class="mb-4">รายงานและสถิติ</h2>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ส่วนนี้อยู่ระหว่างการพัฒนา
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            setupTabSwitching();
            updateTime();
            setInterval(updateTime, 1000);
        });

        // Check admin authentication
        async function checkAdminAuth() {
            authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                window.location.href = '/login?returnUrl=/admin';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    
                    if (!['admin', 'superadmin'].includes(currentUser.role)) {
                        showAlert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้', 'danger');
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 2000);
                        return;
                    }
                    
                    document.getElementById('adminUsername').textContent = currentUser.username;
                    loadDashboardData();
                } else {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/admin';
                }
            } catch (error) {
                console.error('Admin auth error:', error);
                window.location.href = '/login?returnUrl=/admin';
            }
        }

        // Setup tab switching
        function setupTabSwitching() {
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.dataset.tab;
                    
                    // Update active tab
                    document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName + '-content').classList.add('active');
                    
                    // Load data based on tab
                    loadTabData(tabName);
                });
            });
        }

        // Load tab data
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    await loadDashboardData();
                    break;
                case 'products':
                    await loadProductsData();
                    break;
                case 'users':
                    await loadUsersData();
                    break;
                case 'orders':
                    await loadOrdersData();
                    break;
                case 'payments':
                    await loadPaymentsData();
                    break;
                case 'settings':
                    await loadSettingsData();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data.statistics;
                    document.getElementById('totalUsers').textContent = stats.users.total_users;
                    document.getElementById('totalProducts').textContent = stats.products.total_products;
                    document.getElementById('totalOrders').textContent = stats.orders.total_orders;
                    document.getElementById('totalRevenue').textContent = formatPrice(stats.orders.total_revenue);
                    
                    // Load recent activities
                    loadRecentActivities(data.data.recent_activities);
                    loadTopProducts(data.data.top_products);
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
            }
        }

        // Load recent activities
        function loadRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">ไม่มีกิจกรรม</div>';
                return;
            }

            container.innerHTML = activities.map(activity => `
                <div class="d-flex align-items-center py-2 border-bottom">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-${getActivityIcon(activity.action)} text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-medium">${getActivityText(activity)}</div>
                        <small class="text-muted">${formatDate(activity.created_at)}</small>
                    </div>
                </div>
            `).join('');
        }

        // Load top products
        function loadTopProducts(products) {
            const container = document.getElementById('topProducts');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">ไม่มีข้อมูล</div>';
                return;
            }

            container.innerHTML = products.map((product, index) => `
                <div class="d-flex align-items-center justify-content-between py-2 ${index < products.length - 1 ? 'border-bottom' : ''}">
                    <div>
                        <div class="fw-medium">${product.name}</div>
                        <small class="text-muted">ขายแล้ว ${product.total_sales} ครั้ง</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-medium text-success">${formatPrice(product.total_revenue)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Load products data
        async function loadProductsData() {
            try {
                const response = await fetch('/api/products', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('productsTable');
                if (data.success && data.data.products.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>สินค้า</th>
                                        <th>หมวดหมู่</th>
                                        <th>ราคา</th>
                                        <th>ขายแล้ว</th>
                                        <th>สถานะ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.products.map(product => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="${product.image_url || '/images/logo.png'}" 
                                                         class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                                    <div>
                                                        <div class="fw-medium">${product.name}</div>
                                                        <small class="text-muted">${product.product_type}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${product.category_name || 'ไม่ระบุ'}</td>
                                            <td>${formatPrice(product.final_price)}</td>
                                            <td>${product.total_sales}</td>
                                            <td>
                                                <span class="badge bg-${product.is_active ? 'success' : 'secondary'}">
                                                    ${product.is_active ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center text-muted py-3">ไม่มีสินค้า</div>';
                }
            } catch (error) {
                console.error('Load products error:', error);
            }
        }

        // Load users data
        async function loadUsersData() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('usersTable');
                if (data.success && data.data.users.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ผู้ใช้</th>
                                        <th>อีเมล</th>
                                        <th>เครดิต</th>
                                        <th>คำสั่งซื้อ</th>
                                        <th>สถานะ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.users.map(user => `
                                        <tr>
                                            <td>
                                                <div>
                                                    <div class="fw-medium">${user.username}</div>
                                                    <small class="text-muted">เข้าร่วม ${formatDate(user.created_at)}</small>
                                                </div>
                                            </td>
                                            <td>${user.email}</td>
                                            <td>${formatPrice(user.credits)}</td>
                                            <td>${user.total_orders}</td>
                                            <td>
                                                <span class="badge bg-${user.is_blacklisted ? 'danger' : (user.is_active ? 'success' : 'secondary')}">
                                                    ${user.is_blacklisted ? 'ถูกแบน' : (user.is_active ? 'ใช้งานได้' : 'ปิดใช้งาน')}
                                                </span>
                                            </td>
                                            <td>
                                                ${!user.is_blacklisted ? 
                                                    `<button class="btn btn-sm btn-outline-danger" onclick="blacklistUser(${user.id})">
                                                        <i class="fas fa-ban"></i>
                                                    </button>` :
                                                    `<button class="btn btn-sm btn-outline-success" onclick="unblacklistUser(${user.id})">
                                                        <i class="fas fa-check"></i>
                                                    </button>`
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center text-muted py-3">ไม่มีผู้ใช้</div>';
                }
            } catch (error) {
                console.error('Load users error:', error);
            }
        }

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('th-TH');
        }

        // Helper functions
        function getActivityIcon(action) {
            const icons = {
                'user_register': 'user-plus',
                'user_login': 'sign-in-alt',
                'order_completed': 'shopping-bag',
                'product_created': 'plus',
                'payment_approved': 'check'
            };
            return icons[action] || 'info-circle';
        }

        function getActivityText(activity) {
            const user = activity.username || 'ผู้ใช้';
            const actions = {
                'user_register': `${user} สมัครสมาชิก`,
                'user_login': `${user} เข้าสู่ระบบ`,
                'order_completed': `${user} สั่งซื้อสำเร็จ`,
                'product_created': `สินค้าใหม่ถูกเพิ่ม`,
                'payment_approved': `การเติมเงินได้รับการอนุมัติ`
            };
            return actions[activity.action] || activity.action;
        }

        async function showCreateProductModal() {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productModalLabel').textContent = 'เพิ่มสินค้าใหม่';
        // Load categories into select
        await loadCategoriesForModal();
        const productModal = new bootstrap.Modal(document.getElementById('productModal'));
        productModal.show();
        }

        async function editProduct(id) {
        document.getElementById('productForm').reset();
        await loadCategoriesForModal();

        try {
            const response = await fetch(`/api/products/${id}`);
            const data = await response.json();
            if (data.success) {
                const product = data.data.product;
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category_id;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productDiscountPrice').value = product.discount_price || '';
                document.getElementById('productType').value = product.product_type;
                document.getElementById('productIsActive').checked = product.is_active;
                
                document.getElementById('productModalLabel').textContent = `แก้ไขสินค้า: ${product.name}`;
                const productModal = new bootstrap.Modal(document.getElementById('productModal'));
                productModal.show();
            } else {
                showAlert(data.error || 'ไม่สามารถโหลดข้อมูลสินค้าได้', 'danger');
            }
        } catch (err) {
            showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
        }
    }

    async function submitProductForm() {
        const productId = document.getElementById('productId').value;
        const isUpdate = !!productId;
        const url = isUpdate ? `/api/admin/products/${productId}` : '/api/admin/products';
        const method = isUpdate ? 'PUT' : 'POST';

        const formData = new FormData();
        formData.append('name', document.getElementById('productName').value);
        formData.append('category_id', document.getElementById('productCategory').value);
        formData.append('description', document.getElementById('productDescription').value);
        formData.append('price', document.getElementById('productPrice').value);
        formData.append('discount_price', document.getElementById('productDiscountPrice').value);
        formData.append('product_type', document.getElementById('productType').value);
        formData.append('is_active', document.getElementById('productIsActive').checked);
        // Add other fields as needed (file uploads, etc.)

        try {
            // FormData is not sent as 'application/json'
            const response = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${authToken}` },
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                showAlert(`บันทึกข้อมูลสินค้าสำเร็จ`, 'success');
                const productModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                productModal.hide();
                loadProductsData(); // Reload table
            } else {
                showAlert(data.error || 'เกิดข้อผิดพลาด', 'danger');
            }
        } catch (err) {
             showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
        }
    }

    async function loadCategoriesForModal() {
        const select = document.getElementById('productCategory');
        if (select.options.length > 1) return; // Already loaded
        try {
            const response = await fetch('/api/products/categories');
            const data = await response.json();
            if(data.success) {
                select.innerHTML = '<option value="">เลือกหมวดหมู่...</option>';
                data.data.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            }
        } catch(err) {
             console.error('Failed to load categories for modal', err);
        }
    }

         async function deleteProduct(id) {
        if (confirm('คุณต้องการลบสินค้านี้ใช่หรือไม่? (การกระทำนี้จะเปลี่ยนสถานะเป็น "ปิดใช้งาน")')) {
            try {
                 const response = await fetch(`/api/admin/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                 const data = await response.json();
                 if (data.success) {
                    showAlert('ลบสินค้าสำเร็จ', 'success');
                    loadProductsData();
                 } else {
                    showAlert(data.error || 'เกิดข้อผิดพลาด', 'danger');
                 }
            } catch(err) {
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
            }
        }
    }

        async function blacklistUser(id) {
        if (confirm('คุณต้องการแบนผู้ใช้นี้หรือไม่?')) {
             try {
                 const response = await fetch(`/api/admin/users/${id}/blacklist`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ reason: 'Blacklisted by admin' })
                });
                 const data = await response.json();
                 if (data.success) {
                    showAlert('แบนผู้ใช้สำเร็จ', 'success');
                    loadUsersData();
                 } else {
                    showAlert(data.error || 'เกิดข้อผิดพลาด', 'danger');
                 }
            } catch(err) {
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
            }
        }
    }

    async function unblacklistUser(id) {
        if (confirm('คุณต้องการยกเลิกการแบนผู้ใช้นี้หรือไม่?')) {
             try {
                 const response = await fetch(`/api/admin/users/${id}/unblacklist`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                 const data = await response.json();
                 if (data.success) {
                    showAlert('ยกเลิกการแบนสำเร็จ', 'success');
                    loadUsersData();
                 } else {
                    showAlert(data.error || 'เกิดข้อผิดพลาด', 'danger');
                 }
            } catch(err) {
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
            }
        }
    }

        async function loadOrdersData() {
            // TODO: Implement load orders
            document.getElementById('ordersTable').innerHTML = '<div class="text-center text-muted py-3">ส่วนนี้อยู่ระหว่างการพัฒนา</div>';
        }

        async function loadPaymentsData() {
            // TODO: Implement load payments
            document.getElementById('pendingPayments').innerHTML = '<div class="text-center text-muted py-3">ส่วนนี้อยู่ระหว่างการพัฒนา</div>';
        }

        async function loadSettingsData() {
            // TODO: Implement load settings
            console.log('Loading settings...');
        }
    </script>
</body>
</html>